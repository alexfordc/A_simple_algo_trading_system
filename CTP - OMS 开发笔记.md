[TOC]

# CTP - OMS 开发笔记

## 已知或可能出现的BUG

1. 由于目前选用的持仓更新算法，交易所推送的非上期所昨仓记录是不变的，因此非上期所的昨仓记录可能错误，但总仓位是对的。例如，原有昨仓3手，平仓2手后，持仓记录为`持仓：1，今仓：-2，昨仓3`。即非上期所记录的持仓信息为，今日变化仓位和昨日结算仓位。上期所仓位记录正常。此BUG对交易算法的使用无任何影响。

## 待开发

1. ​

## 待确认

1. ​

## 已确认

1. 除上期所外，平昨、平今和平仓三个指令都可用于平仓。上期所，平今只能平今，平仓和平昨只能平昨。
2. **订单回报**平仓标志：
   1. 所有：平仓 - 平仓；平昨 - 未知；平今 - 未知
3. **成交回报**平仓标志：
   1. 上期所：平仓 - 平昨；平昨 - 平昨；平今 - 平今
   2. 其他：平仓 - 平仓；平昨 - 平昨；平今 - 平今
4. CTP返回的持仓信息：
   1. 上期所返回今仓和昨仓两条数据，今仓中昨仓为0，昨仓中今仓为0。
   2. 其他三个交易所返回一条数据，今仓+昨仓=持仓。vt系统处理错误。
   3. 若当日有平昨交易，上期所返回的持仓信息的昨仓是会变化的。但是，若当日非上期所有平仓交易，返回的持仓数据的昨仓不会变化。若不处理昨仓，有可能得到负数的今仓。
5. 下平仓单会冻结持仓：
   1. 非上期所，冻结持仓不分昨仓和今仓。
   2. 上期所，冻结持仓也分别在两条记录中，必须特殊处理。
6. 非上期所平仓先平昨。

##其他备注
1. 由于策略是在接收到tick数据的时候才会下单，因此，若Insert Timer时间到，可以下单，但没有数据推送时，会等到下一次CTP推送数据时才下单。若有需要，可改为使用上一个tick的数据下单。
2. 因为需要与C++ API的数据类型对接，所以str和unicode不能乱用。
3. 由于平仓标志返回的原因，上期所使用**平仓**和**平今**，其他交易所使用**平仓**。
4. 持仓更新目前的算法：CTP连接后，读取当前持仓并保存。此后每次下单，冻结持仓增加；撤单，冻结持仓减少；成交，冻结持仓减少，上期所减少相应的昨仓和今仓，非上期所减少总持仓。